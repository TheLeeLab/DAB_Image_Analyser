<!--
    Copyright 2020 Hendrik Weimer

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DAB Stain Analyser</title>
  </head>
  <body>
    <div id="loadingMessage" style="display: block;">Loading...</div>
    <div id="appContainer" style="display: none">
      <canvas id="canvas" style="width: 100%; display: none"></canvas>
      <form id="parameterForm">

        <div id="asynParameters">
          <label for="asyn_LMean">asyn_LMean:</label>
          <input type="number" id="asyn_LMean" name="asyn_LMean" value="27" step="0.01"><br><br> <!--  TODO: proper CSS styling rather than line breaks -->
          
          <label for="asyn_aMean">asyn_aMean:</label>
          <input type="number" id="asyn_aMean" name="asyn_aMean" value="6" step="0.01"><br><br>
          
          <label for="asyn_bMean">asyn_bMean:</label>
          <input type="number" id="asyn_bMean" name="asyn_bMean" value="5" step="0.01"><br><br>
          
          <label for="asyn_threshold">asyn_threshold:</label>
          <input type="number" id="asyn_threshold" name="asyn_threshold" value="15" step="0.01"><br><br>
        </div>

        <label for="analyseNuclei">Analyse Nuclei?:</label>
        <input type="checkbox" id="analyseNuclei"/>

        <div id="nucleiParameters" style="display: none">
          <label for="nuclei_LMean">nuclei_LMean:</label>
          <input type="number" id="nuclei_LMean" name="nuclei_LMean" value="70" step="0.01"><br><br>
          
          <label for="nuclei_aMean">nuclei_aMean:</label>
          <input type="number" id="nuclei_aMean" name="nuclei_aMean" value="1" step="0.01"><br><br>
          
          <label for="nuclei_bMean">nuclei_bMean:</label>
          <input type="number" id="nuclei_bMean" name="nuclei_bMean" value="-5" step="0.01"><br><br>
          
          <label for="nuclei_threshold">nuclei_threshold:</label>
          <input type="number" id="nuclei_threshold" name="nuclei_threshold" value="4" step="0.01"><br><br>
        </div>
      </form>
      <input type="number" id="fileNumber" value="0" step="1"/>
      <input type="file" id="imageUpload" accept="image/*" multiple="true"/>
      <button id="reanalyse" style="display: none">Reanalyse with current parameters</button>
    </div>
      <button id="downloadZip" style="display: none;">Download Zip</button>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
      <script type="text/javascript">
      let pyodide;
      let pyodidePackageMessage;
      let pyodidePackageError;

      window.onload = async function() {
        pyodide = await loadPyodide();
        await pyodide.loadPackage(
          ["numpy", "matplotlib", "scikit-image", "opencv-python", "pandas"],
          {
            messageCallback: pyodideLoaded,
            errorCallback: (err) => {pyodidePackageError = err; console.log(err)}
          }
        );
      };

      function pyodideLoaded(message) {

        pyodidePackageMessage = message;
        console.log(message);

        // Stop displaying loading message and display main app instead
        if (pyodidePackageMessage.startsWith('Loaded')) {
          let loadingMessage = document.querySelector("#loadingMessage");
          loadingMessage.style = "display: none";
          let appContainer = document.querySelector("#appContainer");
          appContainer.style = "display: block";
        }
      }
      
      
      const body = document.querySelector("body");
      const canvas = document.querySelector("#canvas");
      const imageUpload = document.querySelector("#imageUpload");
      const downloadZip = document.querySelector("#downloadZip");
      const reanalyseButton = document.querySelector("#reanalyse")
      const parameterForm = document.querySelector("#parameterForm");
      const nucleiParameters = document.querySelector("#nucleiParameters");
      const analyseNuclei = document.querySelector("#analyseNuclei")

      downloadZip.addEventListener('click', () => {
        if (pyodide.FS.analyzePath('output.zip').exists) {
          bytes = pyodide.FS.readFile("output.zip")
          var blob = new Blob([bytes], {type: "application/x-zip"})
          var link = document.createElement('a');
          link.href = window.URL.createObjectURL(blob);
          link.download = "output.zip";
          link.click();
        } else (
          console.log("No file")
        )
      })

      reanalyseButton.addEventListener('click', (evt) => {
        evt.preventDefault();
        console.log('running');
        runAnalysis();
      })

      body.ondrop = function(evt) {
        imageUpload.files = evt.dataTransfer.files;
        evt.preventDefault();
        console.log('running');
        runAnalysis();
      }

      imageUpload.onchange = function(evt) {
        evt.preventDefault();
        console.log('running');
        runAnalysis();
      }

      parameterForm.addEventListener("keypress", function(evt) {
        evt.preventDefault();
        if (event.key === "Enter") {
          console.log('running');
          runAnalysis();
        }
      })

      analyseNuclei.addEventListener("change", (evt) => {
        if (analyseNuclei.checked) {
          nucleiParameters.style = "display: block"
        } else {
          nucleiParameters.style = "display: none"
        }
      })

      async function runAnalysis() {
        let maxAttempts = 10;
        let attempts = 0;
        while (!pyodide || !pyodidePackageMessage || !pyodidePackageMessage.startsWith("Loaded")) {
          if (attempts >= maxAttempts || pyodidePackageError) {
            console.error('Pyodide failed to initialise or load packages');
            return;
          }
          await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for 1 second
          attempts++;
        }
        if (imageUpload.files.length > 0) {
          let fileNumber = document.querySelector("#fileNumber");
          const file = imageUpload.files[fileNumber.value];
          const reader = new FileReader();
          reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const dataDirectory = '/home/pyodide/data';
            try {
              pyodide.FS.mkdir(dataDirectory);
            } catch (err) {
              // Directory might already exist, which is fine
            }
            const filePath = dataDirectory + '/' + file.name;
            pyodide.FS.writeFile(filePath, data);
            // Copy DAB_Analysis_Functions.py from where it lives on our server (http://example.com/DAB_Analysis_Functions.py)
            // to the Emscripten MEMFS filesystem (/home/pyodide/...) where pyodide has access to it.
            await pyodide.runPythonAsync(`
                import os
                if not os.path.exists("DAB_Analysis_Functions.py"):
                    from pyodide.http import pyfetch
                    response = await pyfetch("DAB_Analysis_Functions.py")
                    with open("DAB_Analysis_Functions.py", "wb") as f:
                        f.write(await response.bytes())
            `)
            canvas.style = "display: block";


            // Load and run "pyodide_DAB_wrapper.py" which takes the input data from the form,
            // runs the computation that outputs matplotlib plot, and writes to HTML canvas
            // pyodide_DAB_wrapper.py has access to the DAB_Analysis_Functions module just as if it were a real local file:
            // from DAB_Analysis_Functions import DAB
            pyodide.runPython(await (await fetch("pyodide_DAB_wrapper.py")).text());
          }
          reader.readAsArrayBuffer(file);
        } else {
          console.error('No file selected');
        }
      }
    </script>
  </body>
</html>
    
