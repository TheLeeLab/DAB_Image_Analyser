<!--
    Copyright 2020 Hendrik Weimer

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DAB Stain Analyser</title>
  </head>
  <body>
    <style>
       body { font-size: 200%; }
      .mtable table td tr { display: block; border-collapse: collapse; }
      .mtable td { vertical-align: top; }
      input { width: 80px; font-size: 100%; }
      .error { color: red; font-size: 75%; }
      .potential { width: 250px; }
       .controls td { padding-left: 10px; padding-right: 20px;}
       table.controls { border: 1px solid black; }
       p.status { font-size: 75%; }
    </style>
    <table class="mtable" style="width: 100%; max-width: 1024px;">
      <tbody>
	<tr>
	  <td id="parent" style="width: 60%;">
	    <p id="status" class="status">Loading Pyodide...</p>  
	    <canvas id="canvas" style="width: 100%;"></canvas>
	    <table class="controls">
	      <tr>
		<td>1/Temperature</td>
		<td>Mass</td>
		<td>Potential</td>
	      </tr>
	      <tr>
		<td><input id="beta" value="1.0" ></td>
		<td><input id="m" value="1.0" ></td>
		<td><input id="V" class="potential" value="1/2*x**2" ></td>
	      </tr>
	      <tr>
		<td><p class="error" id="lbeta"></p></td>
		<td><p class="error" id="lm"></p></td>
		<td><p class="error" id="lV"></p></td>
              </tr>
	    </table>
	  </td>
	  <td style="width: 30%;">
	    <table>
	      <tr>
		<td>
		  <img id="phase" style="width: 100%;">
		</td>
	      </tr>
	      <tr>
		<td>
		  <img id="xpdf" style="width: 100%;">
		</td>
	      </tr>
	      <tr>
		<td>
		  <img id="vpdf" style="width: 100%;">
		</td>
	      </tr>
	    </table>
	  </td>
	</tr>
      </tbody>
    </table>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
      <script type="text/javascript">
      async function main() {
        let pyodide = await loadPyodide();
      
        // Make sure the packages we need are available to python
        await pyodide.loadPackage(["numpy", "matplotlib", "sympy", "scikit-image", "opencv-python", "pandas"]);
        // const micropip = pyodide.pyimport("micropip");
        // await micropip.install('pylibtiff');
        // Copy DAB_Analysis_Functions.py from where it lives on our server (http://example.com/DAB_Analysis_Functions.py)
        // to the "virtual filesystem" (/home/pyodide/...) where pyodide has access to it.
        await pyodide.runPythonAsync(`
            from pyodide.http import pyfetch
            response = await pyfetch("DAB_Analysis_Functions.py")
            with open("DAB_Analysis_Functions.py", "wb") as f:
                f.write(await response.bytes())
        `)
        // Note that if we wanted we could access functions from DAB_Analysis_Functions within Javascript:
          // DAB = pyodide.pyimport("DAB_Analysis_Functions");
          // DAB.helloWorld(); // This prints "Hello world!" to the console


        // XXX: This will no longer be needed once we upload the file from the user's computer, but for testing we need to copy the example image to the virtual filesystem
        await pyodide.runPythonAsync(`
            from pyodide.http import pyfetch
            response = await pyfetch("data/4.ome.tif")
            with open("4.ome.tif", "wb") as f:
                f.write(await response.bytes())
        `)

        // Load and run "test.py" which takes the input data from the form,
        // runs the computation that outputs matplotlib plot, and writes to HTML canvas
        // test.py has access to the DAB_Analysis_Functions module just as if it were a real local file:
        // from DAB_Analysis_Functions import DAB
        pyodide.runPython(await (await fetch("test.py")).text());
      }
      main();
    </script>
  </body>
</html>
    
